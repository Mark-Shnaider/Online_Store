@using Online_Store.Models
@using System.Globalization

@model ShoppingCartViewModel

@{
    ViewData["Title"] = "Index";
}

<table>
    <tbody>
        @foreach (var product in Model.Products)
        {
            <tr>
                <td>
                    <div ng- class="product-wrap">
                        <div class="product-item">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/a/ac/No_image_available.svg">
                        </div>
                        <div class="product-title">
                            <a class="fs-4" asp-controller="Product" asp-action="Details">@product.Name</a> <br />
                            <h3>₽ @product.Price</h3>
                        </div>
                    </div>
                </td>

                <td>
                    <div class="product-container">
                        <input id="@product.GetHashCode()" value="@product.Total" readonly>
                        <div class="product-amount">
                            <a class="btn badge-info" onclick="changeValue(document.getElementById('@product.Id'), document.getElementById('@product.GetHashCode()'),@product.Total ,@product.Price.ToString(CultureInfo.InvariantCulture), -1)">-</a>
                            <input type="number" id="@product.Id" asp-for="@product.Amount" min="1" step="1">
                            <a class="btn badge-info" onclick="changeValue(document.getElementById('@product.Id'), document.getElementById('@product.GetHashCode()'),@product.Total ,@product.Price.ToString(CultureInfo.InvariantCulture), 1)">+</a>
                        </div>
                        <input type="submit" data-product-id="@product.Id" data-cart-id="@Model.Id" onclick="RemoveFromCart(this)" value="Remove from cart" />
                        <input type="submit" data-product-id="@product.Id" data-cart-id="@Model.Id" onclick="AddToCart(this)" value="Add to cart" />
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>


<form asp-controller="Product" asp-action="Index">
    <input type="submit" asp-route=""/>
    </form>

<script type="text/javascript">
    function changeValue(target, output, amount, price, num) {
        let val = parseInt(target.value);
        if (num < 0 && val <= 1) {
            return;
        }
        val += num;
        target.value = val;

        let totalInt = val * price;
        output.value = ('' + totalInt).substring(0, 6);
    }

    AddToCart = function (element) {
        var amount = document.querySelector(".product-amount").children[1].valueAsNumber;
        var ProductId = $(element).data("product-id");
        var CartId = $(element).data("cart-id");
        $.ajax({
            type: "POST",
            url: '@Url.Action("Add", "ShoppingCart")',
            data: {
                CartId: CartId,
                ProductId: ProductId,
                amount: amount
            },
            success: function (data) {
                if (data.data.isValid == false)
                   alert("На складе нет столько товаров")
            },
            error: function () {
                AjaxError();
            }
        });
    };
    RemoveFromCart = function (element) {
        
        var amount = document.querySelector(".product-amount").children[1].valueAsNumber;
        var ProductId = $(element).data("product-id");
        var CartId = $(element).data("cart-id");
        $.ajax({
            type: "POST",
            url: '@Url.Action("Add", "ShoppingCart")',
            data: {
                CartId: CartId,
                ProductId: ProductId,
                amount: amount
            },
            success: function (data) {
                if (data.data.isValid == false)
                   alert("На складе нет столько товаров")
            },
            error: function () {
                AjaxError();
            }
        });
    };



    function readUrl(input, id) {
        if (input && input.value) {
            $('#' + id).attr('src', input.value);
        }
    }
</script>